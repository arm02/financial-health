<div class="todos-container">
  <!-- Quick Add Section -->
  <div class="quick-add-section">
    <div class="quick-add-input">
      <input
        type="text"
        [(ngModel)]="newTodoTitle"
        (keydown.enter)="quickAdd()"
        placeholder="What needs to be done? Press Enter to add..."
        class="todo-input"
      />
      <button
        class="btn-icon"
        (click)="showQuickOptions = !showQuickOptions"
        [class.active]="showQuickOptions"
      >
        <mat-icon>tune</mat-icon>
      </button>
      <button class="btn-primary" (click)="quickAdd()" [disabled]="!newTodoTitle.trim()">
        <mat-icon>add</mat-icon>
      </button>
    </div>

    @if (showQuickOptions) {
    <div class="quick-options">
      <div class="option-group">
        <label>Priority</label>
        <div class="priority-buttons">
          @for (p of priorities; track p.value) {
          <button
            class="priority-btn"
            [class.active]="newTodoPriority === p.value"
            [style.--priority-color]="p.color"
            (click)="newTodoPriority = $any(p.value)"
          >
            {{ p.label }}
          </button>
          }
        </div>
      </div>
      <div class="option-group">
        <label>Due Date</label>
        <input type="date" [(ngModel)]="newTodoDueDate" class="date-input" />
      </div>
    </div>
    }
  </div>

  <!-- Filters & Stats -->
  <div class="filters-section">
    <div class="stats">
      <span class="stat pending">{{ pendingCount }} pending</span>
      <span class="stat completed">{{ completedCount }} completed</span>
    </div>
    <div class="filters">
      <select [(ngModel)]="filterStatus" (change)="onFilterChange()">
        <option value="">All Status</option>
        @for (s of statuses; track s.value) {
        <option [value]="s.value">{{ s.label }}</option>
        }
      </select>
      <select [(ngModel)]="filterPriority" (change)="onFilterChange()">
        <option value="">All Priority</option>
        @for (p of priorities; track p.value) {
        <option [value]="p.value">{{ p.label }}</option>
        }
      </select>
      @if (filterStatus || filterPriority) {
      <button class="btn-text" (click)="clearFilters()">Clear</button>
      }
    </div>
  </div>

  <!-- Todo List -->
  <div class="todo-list">
    @if (loader()) {
    <loader class="loader" [visibility]="loader()"></loader>
    } @if (!loader() && todos.length === 0) {
    <div class="empty-state">
      <mat-icon>check_circle</mat-icon>
      <p>No todos yet. Add one above!</p>
    </div>
    } @for (todo of todos; track todo.id) {
    <div
      class="todo-item"
      [class.completed]="todo.status === 'completed'"
      [class.editing]="editingTodo?.id === todo.id"
    >
      @if (editingTodo?.id === todo.id) {
      <!-- Edit Mode -->
      <div class="edit-form">
        <input type="text" [(ngModel)]="editTitle" class="edit-input" placeholder="Title" />
        <textarea
          [(ngModel)]="editDescription"
          class="edit-textarea"
          placeholder="Description (optional)"
          rows="2"
        ></textarea>
        <div class="edit-options">
          <div class="option-group">
            <label>Priority</label>
            <div class="priority-buttons small">
              @for (p of priorities; track p.value) {
              <button
                class="priority-btn"
                [class.active]="editPriority === p.value"
                [style.--priority-color]="p.color"
                (click)="editPriority = $any(p.value)"
              >
                {{ p.label }}
              </button>
              }
            </div>
          </div>
          <div class="option-group">
            <label>Due Date</label>
            <input type="date" [(ngModel)]="editDueDate" class="date-input" />
          </div>
        </div>
        <div class="edit-actions">
          <button class="btn-text" (click)="cancelEdit()">Cancel</button>
          <button class="btn-primary" (click)="saveEdit()">Save</button>
        </div>
      </div>
      } @else {
      <!-- View Mode -->
      <div class="todo-checkbox" (click)="toggleStatus(todo)">
        <mat-icon>{{
          todo.status === 'completed' ? 'check_circle' : 'radio_button_unchecked'
        }}</mat-icon>
      </div>
      <div class="todo-content" (click)="startEdit(todo)">
        <div class="todo-title">{{ todo.title }}</div>
        @if (todo.description) {
        <div class="todo-description">{{ todo.description }}</div>
        }
        <div class="todo-meta">
          <span class="priority-badge" [style.background]="getPriorityColor(todo.priority)">
            {{ todo.priority }}
          </span>
          @if (todo.due_date) {
          <span class="due-date">
            <mat-icon>event</mat-icon>
            {{ todo.due_date | date : 'd MMM y' : 'UTC' }}
          </span>
          }
        </div>
      </div>
      <div class="todo-actions">
        <button class="btn-icon" (click)="startEdit(todo)">
          <mat-icon>edit</mat-icon>
        </button>
        <button class="btn-icon danger" (click)="deleteTodo(todo)">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
      }
    </div>
    }
  </div>
</div>
